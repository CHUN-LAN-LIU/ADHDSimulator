<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ADHD æ¨¡æ‹Ÿå™¨ - æ·±åº¦è§£æå®Œæˆç‰ˆ</title>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:#f3f4f6; overflow:hidden; }
    .center-container{ width:100%; height:100%; display:flex; justify-content:center; align-items:center; }
    
    .task-card{
      background:#fff; padding:24px; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.05);
      max-width: 980px; width:min(980px, calc(100vw - 24px)); text-align:center; position:relative;
      overflow: hidden; 
      display: flex; flex-direction: column;
    }

    .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .topbar-left { text-align: left; }
    .topbar h1{ margin:0; font-size:20px; color:#111827; }
    .topbar p{ margin:4px 0 0; font-size:13px; color:#6b7280; }
    
    .btn-group { display: flex; gap: 10px; }
    .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: transform 0.1s; text-decoration: none; display: inline-flex; justify-content: center; align-items: center; }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: #111827; color: white; }
    .btn-reset { background: #f3f4f6; color: #4b5563; }
    
    .btn-science { 
      background: #059669; color: white; width: 100%; margin-top: 12px; padding: 12px; font-size: 16px;
      box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
    }
    .btn-science:hover { background: #047857; box-shadow: 0 6px 16px rgba(5, 150, 105, 0.3); }

    .require-box{ text-align:left; background:#f9fafb; border:1px solid #e5e7eb; border-radius:14px; padding:15px; margin: 15px 0; }
    .task-desc { color: #374151; font-size: 14px; line-height: 1.6; margin-bottom: 8px; font-weight: 500; }
    .highlight { color: #b91c1c; background: #fef2f2; padding: 0 4px; border-radius: 4px; }
    
    .task-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 8px; }
    .progress-pill{ background:#fff; border:1px solid #e5e7eb; padding:2px 8px; border-radius:4px; transition: all 0.3s; }
    .progress-pill.done { color: #059669; border-color: #059669; background: #ecfdf5; font-weight: bold; }

    .editor{
      width:100%; height: 400px; padding:16px; border-radius:12px; border:1px solid #d1d5db;
      background:#fff; text-align:left; outline:none; line-height:1.7; font-size:16px;
      overflow-y:auto; position:relative; box-sizing: border-box; z-index: 10;
    }
    .editor.locked { border-color: #ef4444; background: #fff5f5; animation: editorPulse 2s infinite; }
    @keyframes editorPulse { 0%, 100% { box-shadow: 0 0 0px rgba(239, 68, 68, 0.2); } 50% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); } }

    .editor.is-empty::before{ content: attr(data-placeholder); color:#9ca3af; pointer-events:none; position: absolute; }
    .dmn-span{ color: #a1a1aa; font-style: italic; letter-spacing: 0.5px; }

    .bottom-nav {
      margin-top: 20px; padding-top: 15px; border-top: 1px solid #f3f4f6;
      display: flex; justify-content: flex-start; align-items: center;
    }
    .nav-link {
      text-decoration: none; color: #9ca3af; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: all 0.2s; padding: 6px 10px; border-radius: 6px;
    }
    .nav-link:hover { background: #f3f4f6; color: #4b5563; }

    .side-pop{
      position:absolute; width: 240px; padding: 12px 16px; border-radius: 12px;
      background: rgba(255,255,255,0.95); border: 1px solid #e5e7eb;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      color: #6b7280; font-size: 13px; pointer-events:none; z-index: 20;
      text-align: left; line-height: 1.5;
      backdrop-filter: blur(4px);
      animation: popInOut 5s ease-in-out forwards;
    }
    @keyframes popInOut{
      0% { opacity:0; transform:translateY(15px) scale(0.95); }
      10% { opacity:1; transform:translateY(0) scale(1); }
      80% { opacity:1; transform:translateY(0) scale(1); }
      100% { opacity:0; transform:translateY(-15px) scale(0.95); }
    }

    .meme-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,0.95);
      display:none; justify-content:center; align-items:center; z-index:100; flex-direction:column;
    }
    @keyframes zoomIn { from { transform: scale(0.6); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
    
    .meme-overlay.active .meme-content { 
      animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
      width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .meme-overlay.active img { animation: glitch 0.3s infinite; }
    
    .meme-overlay img { 
      max-width: 90vw; max-height: 80vh; 
      object-fit: contain; border-radius:12px; border: 4px solid #fff; 
      box-shadow: 0 0 50px rgba(255,255,255,0.3); margin-bottom: 20px;
    }
    .meme-hint{ color:#fff; margin-bottom:15px; text-align:center; font-size: 24px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

    .btn-restore {
      background: #ef4444; color: white; border: none; padding: 14px 40px; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(239, 68, 68, 0.6); transition: transform 0.1s, box-shadow 0.1s; z-index: 101;
    }
    .btn-restore:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(239, 68, 68, 0.8); }
    .btn-restore:active { transform: scale(0.95); }

    /* ç»“ç®—å¼¹çª— */
    .success-overlay {
      position:fixed; inset:0; background:rgba(255,255,255,0.1); backdrop-filter: blur(8px);
      display:none; justify-content:center; align-items:center; z-index: 200;
    }
    .result-card {
      background: #fff; width: 600px;
      max-width: 90vw; max-height: 90vh; overflow-y: auto;
      padding: 30px; border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2); text-align: center;
      animation: cardUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid #e5e7eb;
    }
    @keyframes cardUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .result-icon { font-size: 48px; margin-bottom: 10px; display:block; }
    .result-title { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: #111827; }
    .result-desc { color: #6b7280; font-size: 14px; margin-bottom: 25px; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 25px; }
    .stat-item { background: #f9fafb; padding: 10px; border-radius: 12px; border: 1px solid #f3f4f6; }
    .stat-val { display: block; font-size: 18px; font-weight: bold; color: #111827; }
    .stat-label { font-size: 11px; color: #9ca3af; }

    /* ä½“éªŒè§£ç åŒºåŸŸ */
    .debrief-box {
        text-align: left;
        background: #f0fdf4;
        border: 1px solid #dcfce7;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }
    .debrief-title { font-size: 15px; font-weight: bold; color: #166534; margin-bottom: 12px; border-bottom: 1px solid #bbf7d0; padding-bottom: 8px; }
    .debrief-item { margin-bottom: 10px; font-size: 13px; color: #374151; line-height: 1.5; display: flex; gap: 8px; }
    .debrief-item:last-child { margin-bottom: 0; }
    .debrief-icon { font-size: 16px; min-width: 20px; }
    .debrief-bold { font-weight: 600; color: #111827; }

    .toast{
      position:fixed; left:50%; bottom: 20%; transform:translateX(-50%);
      background: rgba(220, 38, 38, 0.95); color: #fff; padding: 16px 32px; border-radius: 50px; font-size: 18px; font-weight: 600; box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4); opacity: 0; transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200; pointer-events: none; white-space: nowrap;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-10px); }
    .debug{ position:absolute; bottom:55px; right:20px; font-size:11px; color:#9ca3af; }
  </style>
</head>
<body>

<div class="center-container">
  <div class="task-card" id="taskCard">
    <div class="topbar">
      <div class="topbar-left">
        <h1>æ’°å†™ï¼šå‘¨æŠ¥è¿Ÿäº¤è§£é‡Šé‚®ä»¶</h1>
        <p>å¼€æ”¾ä»»åŠ¡ï¼šè¯·æ ¹æ®ä¸‹æ–¹è¦æ±‚æ’°å†™é‚®ä»¶ã€‚</p>
      </div>
      <div class="btn-group">
        <button class="btn btn-reset" onclick="location.reload()">é‡ç½®</button>
        <button class="btn btn-primary" id="submitBtn">å‘é€é‚®ä»¶</button>
      </div>
    </div>

    <div class="require-box">
      <div class="task-desc">
        ä»»åŠ¡ï¼šç»™é¢†å¯¼å†™ä¸€å°é‚®ä»¶ï¼Œè§£é‡Š<b>æ•°æ®æ ¸å¯¹æœªå®Œæˆ</b>ä»¥åŠ<b>å‘¨æŠ¥è¿Ÿäº¤</b>çš„åŸå› ï¼Œå¹¶<span class="highlight">æ˜ç¡®å‘ŠçŸ¥å…­ç‚¹å‰è¡¥äº¤</span>ã€‚<br>
        è¦æ±‚ï¼šè¯­ä¹‰é€šé¡ºï¼Œæ€åº¦è¯šæ³ï¼Œå†…å®¹å®Œæ•´ã€‚
      </div>
      <div class="task-meta">
        <span>æœ€ä½å­—æ•°è¦æ±‚ï¼š50å­—</span>
        <span class="progress-pill" id="charCount">0 / 50</span>
      </div>
    </div>

    <div id="editor" class="editor is-empty" contenteditable="true" spellcheck="false" data-placeholder="å°Šæ•¬çš„é¢†å¯¼ï¼Œéå¸¸æŠ±æ­‰..."></div>
    
    <div class="bottom-nav">
        <a href="index.html" class="nav-link">
            <span>â†</span> è¿”å›ä¸»ç•Œé¢
        </a>
    </div>

    <div class="debug" id="debug"></div>
  </div>
</div>

<div class="meme-overlay" id="memeOverlay">
  <div class="meme-content">
    <div class="meme-hint">âš  æ€ç»´å·²è¿‡è½½ âš </div>
    <img src="meme.gif" alt="Focus Hijack">
    <button class="btn-restore" id="closeHijackBtn">å¼ºåˆ¶é‡å¯å¤§è„‘</button>
  </div>
</div>

<div class="success-overlay" id="successOverlay">
  <div class="result-card">
    <span class="result-icon">ğŸ‰</span>
    <div class="result-title">é‚®ä»¶å‘é€æˆåŠŸï¼</div>
    <div class="result-desc">ä½ æˆåŠŸå…‹æœäº†æ‹–å»¶ä¸ç„¦è™‘ï¼Œä½†åˆšæ‰çš„ä½“éªŒå¹¶éæ¸¸æˆã€‚</div>
    
    <div class="stats-grid">
      <div class="stat-item">
        <span class="stat-val" id="statTime">0s</span>
        <span class="stat-label">æ€»è€—æ—¶</span>
      </div>
      <div class="stat-item">
        <span class="stat-val" id="statDeletes">0</span>
        <span class="stat-label">åˆ é™¤æ‚å¿µ</span>
      </div>
      <div class="stat-item">
        <span class="stat-val" id="statDistractions">0</span>
        <span class="stat-label">æ€ç»´é˜»æ–­</span>
      </div>
      <div class="stat-item">
        <span class="stat-val" id="statHijacks">0</span>
        <span class="stat-label">è¢«GIFåŠ«æŒ</span>
      </div>
    </div>

    <div class="debrief-box">
        <div class="debrief-title">ğŸ”¬ åˆšæ‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿä½“éªŒèƒŒåçš„ç¥ç»ç§‘å­¦ï¼š</div>
        
        <div class="debrief-item">
            <span class="debrief-icon">ğŸ‘»</span>
            <div>
                <span class="debrief-bold">è‡ªåŠ¨ç”Ÿæˆçš„ç°å­— (æ€ç»´é˜»æ–­)ï¼š</span> 
                æ¨¡æ‹Ÿ <b>DMNï¼ˆé»˜è®¤æ¨¡å¼ç½‘ç»œï¼‰è¿‡åº¦æ´»è·ƒ</b>ã€‚å³ä¾¿ä½ æƒ³ä¸“æ³¨ï¼Œå¤§è„‘ä¹Ÿä¼šä¸æ–­äº§ç”Ÿæ‚å¿µã€è‡ªæˆ‘è´¨ç–‘ï¼ˆ"è¿™æ ·å†™å¯¹å—ï¼Ÿ"ï¼‰å’Œæ— å…³è”æƒ³ï¼Œå¹²æ‰°ä½ çš„æ€è€ƒæµã€‚
            </div>
        </div>

        <div class="debrief-item">
            <span class="debrief-icon">ğŸˆ</span>
            <div>
                <span class="debrief-bold">å¼ºåˆ¶å…¨å±åŠ¨å›¾ (GIFåŠ«æŒ)ï¼š</span> 
                æ¨¡æ‹Ÿ <b>å¤šå·´èƒºåŒ®ä¹å¯¼è‡´çš„å‰é¢å¶â€œæ­»æœºâ€</b>ã€‚å½“è®¤çŸ¥ç–²åŠ³è¾¾åˆ°æé™ï¼Œå¤§è„‘ä¼šå¼ºåˆ¶åˆ‡æ–­ä»»åŠ¡è¿æ¥ï¼Œå¯»æ‰¾é«˜åˆºæ¿€æºï¼ˆå¦‚åˆ·æ‰‹æœºã€å‘å‘†ï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„â€œæ–­ç‰‡â€ã€‚
            </div>
        </div>

        <div class="debrief-item">
            <span class="debrief-icon">ğŸ›‘</span>
            <div>
                <span class="debrief-bold">åˆ ä¸æ‰çš„é”™å­—/é˜»åŠ›ï¼š</span> 
                æ¨¡æ‹Ÿ <b>æ‰§è¡ŒåŠŸèƒ½éšœç¢</b>ã€‚è¿™æ˜¯å…¸å‹çš„<b>â€œæ„å‘-è¡ŒåŠ¨æ–­è£‚â€</b>ã€‚å¤§è„‘æ¸…æ¥šåœ°å‘å‡ºäº†æŒ‡ä»¤ï¼Œä½†èº«ä½“å´åƒâ€œé¬¼å‹åºŠâ€ä¸€æ ·æ— æ³•å“åº”ã€‚ç®€å•çš„çº é”™åŠ¨ä½œï¼Œåœ¨ç¥ç»å›è·¯ä¸­é­é‡äº†å·¨å¤§çš„<b>è®¤çŸ¥æ‘©æ“¦</b>ï¼Œå˜å¾—å¯¸æ­¥éš¾è¡Œã€‚
            </div>
        </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:8px;">
        <a href="index.html#adhd" class="btn btn-science" style="text-decoration: none;">
            ğŸ“ äº†è§£æ›´å¤šï¼šADHD çš„è„‘ç§‘å­¦åŸç† â†’
        </a>
        
        <button class="btn btn-reset" style="width:100%" onclick="location.reload()">å†è¯•ä¸€æ¬¡</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">æç¤º</div>

<script>
  const MIN_CHARS = 50;
  const STATS = { startTime: Date.now(), deleteCount: 0, distractionCount: 0, hijackCount: 0 };

  const THEME_POOLS = {
    etiquette: { 
      label: "ç¤¾äº¤ç¤¼ä»ª",
      keywords: /(æ‚¨|é¢†å¯¼|ç»ç†|è€å¸ˆ|æŠ±æ­‰|ä¸å¥½æ„æ€|è¾›è‹¦)/, 
      texts: ["â€¦è¯­æ°”ä¼šä¸ä¼šå¤ªå‘å¾®äº†ï¼Ÿ","â€¦è¦ä¸è¦å…ˆé—®å€™ä¸€ä¸‹ä»–å®¶é‡Œçš„çŒ«ï¼Ÿ","â€¦ä»–ç°åœ¨è‚¯å®šåœ¨ç”Ÿæ°”ã€‚","â€¦è¿™å¥è¯è¯»èµ·æ¥æœ‰ç‚¹ç”Ÿç¡¬ã€‚"] 
    },
    logic: { 
      label: "é€»è¾‘æ¼æ´",
      keywords: /(å› ä¸º|å¯¼è‡´|æ‰€ä»¥|ç›®å‰|ä½†æ˜¯|ç„¶è€Œ|ç”±äº)/, 
      texts: ["â€¦è¿™é€»è¾‘ç‹—å±ä¸é€šï¼Œä»–ä¸€çœ¼å°±èƒ½çœ‹ç©¿ã€‚","â€¦ä¸»ä½“å·²å®Œæˆï¼Ÿå“ªéƒ¨åˆ†æ˜¯ä¸»ä½“ï¼Ÿ","â€¦ä¸‡ä¸€ä»–é—®æˆ‘å…·ä½“çš„è¿›åº¦æ€ä¹ˆåŠï¼Ÿ"] 
    },
    data_panic: { 
      label: "æ•°æ®ææ…Œ",
      keywords: /(æ•°æ®|æ ¸å¯¹|é”å®š|å‡†ç¡®|æº|æ£€æŸ¥|å¯¹è´¦)/, 
      texts: ["â€¦é”å®šåå°±ä¸èƒ½æ”¹äº†ï¼Œä¸‡ä¸€æœ‰é”™æ€ä¹ˆåŠï¼Ÿ","â€¦æˆ‘æ˜¯ä¸æ˜¯æ¼ç®—äº†ä¸€ä¸ªSheetï¼Ÿ","â€¦é‚£ä¸ªVLOOKUPå…¬å¼å¥½åƒæ²¡æ‹‰åˆ°åº•ã€‚"] 
    },
    time_panic: { 
      label: "æ—¶é—´ææ…Œ",
      keywords: /(æ—¶é—´|å…­ç‚¹|è¡¥äº¤|é¢„è®¡|è¿Ÿ|æ™š|18:00)/, 
      texts: ["â€¦å…­ç‚¹ä¼šä¸ä¼šå¤ªæ™šäº†ï¼Ÿè¦ä¸è¦æ‹¼ä¸€ä¸‹äº”ç‚¹åŠï¼Ÿ","â€¦è¿™æ—¶å€™å‘é‚®ä»¶ï¼Œä»–ä¼šä¸ä¼šå·²ç»ä¸‹ç­äº†ï¼Ÿ","â€¦ä¸‡ä¸€å…­ç‚¹æˆ‘ä¹Ÿäº¤ä¸å‡ºå‘¢ï¼Ÿ"] 
    },
    general: {
      label: "æ‚å¿µ",
      keywords: /.*/, 
      texts: ["â€¦å¥½é¥¿ï¼Œæƒ³åƒç«é”…ã€‚","â€¦åˆšæ‰é‚£ä¸ªçº¢ç‚¹è¿˜æ²¡æ¶ˆï¼Œå¥½éš¾å—ã€‚","â€¦æˆ‘æ˜¯ä¸æ˜¯ä¸é€‚åˆè¿™ä»½å·¥ä½œï¼Ÿ","â€¦æ‰‹æœºåˆšæ‰æ˜¯ä¸æ˜¯éœ‡äº†ä¸€ä¸‹ï¼Ÿ","â€¦çª—å¤–è¿™åªé¸Ÿå«å¾—çœŸå¤§å£°ã€‚"]
    }
  };

  let lastActiveTheme = "logic";
  let locked = false;
  let dmnPhase = "grow"; 
  let currentThought = ""; 
  let thoughtIndex = 0;    
  let triggerCooldown = 0;
  let stressScore = 0;
  let lastInputTime = Date.now();
  let hijackCooldown = 0;
  let currentLength = 0;
  let isComposing = false;

  const editor = document.getElementById('editor');
  const taskCard = document.getElementById('taskCard');
  const toast = document.getElementById('toast');
  const debugEl = document.getElementById('debug');
  const memeOverlay = document.getElementById('memeOverlay');
  const successOverlay = document.getElementById('successOverlay');
  const submitBtn = document.getElementById('submitBtn');
  const closeHijackBtn = document.getElementById('closeHijackBtn');
  const charCountEl = document.getElementById('charCount');

  function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
  function showToast(msg) { 
    toast.textContent = msg; toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
  }

  function getUserText() {
    const clone = editor.cloneNode(true);
    clone.querySelectorAll('.dmn-span').forEach(s => s.remove());
    return clone.textContent || "";
  }

  function forceCaret() {
    if (!locked) return;
    const span = editor.querySelector('.dmn-span');
    if (!span) return;
    const sel = window.getSelection();
    const range = document.createRange();
    range.setStartBefore(span);
    range.collapse(true);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function spawnSidePop() {
    if (document.querySelectorAll('.side-pop').length > 5) return;
    const pop = document.createElement('div');
    pop.className = 'side-pop';
    const poolKey = Math.random() < 0.6 ? lastActiveTheme : pick(Object.keys(THEME_POOLS));
    pop.textContent = pick(THEME_POOLS[poolKey].texts);
    const cardRect = taskCard.getBoundingClientRect();
    const x = 20 + Math.random() * (cardRect.width - 280);
    const y = 80 + Math.random() * (cardRect.height - 140);
    pop.style.left = x + 'px';
    pop.style.top = y + 'px';
    taskCard.appendChild(pop);
    setTimeout(() => { if(pop.parentNode) pop.remove(); }, 5000);
  }

  submitBtn.addEventListener('click', () => {
    if (currentLength < MIN_CHARS) {
      showToast(`å†…å®¹å¤ªå°‘äº†ï¼è‡³å°‘éœ€è¦å†™ ${MIN_CHARS} å­— (å½“å‰: ${currentLength})`);
      return;
    }
    const duration = Math.floor((Date.now() - STATS.startTime) / 1000);
    document.getElementById('statTime').textContent = duration + "s";
    document.getElementById('statDeletes').textContent = STATS.deleteCount;
    document.getElementById('statDistractions').textContent = STATS.distractionCount;
    document.getElementById('statHijacks').textContent = STATS.hijackCount;
    successOverlay.style.display = 'flex';
  });

  closeHijackBtn.addEventListener('click', () => {
    memeOverlay.classList.remove('active');
    memeOverlay.style.display = 'none';
    stressScore = 0; 
    hijackCooldown = Date.now() + 20000; 
    editor.focus();
    showToast("å¤šå·´èƒºå¹³å¤ï¼Œæ³¨æ„åŠ›å›å½’...");
  });

  editor.addEventListener('compositionstart', (e) => {
    if (locked) {
      editor.blur();
      setTimeout(() => { editor.focus(); forceCaret(); }, 10);
      showToast("æ‚å¿µå¤ªå¤šï¼Œæš‚æ—¶æ‰“ä¸å‡ºå­—...");
      return;
    }
    isComposing = true;
  });

  editor.addEventListener('compositionend', (e) => {
    isComposing = false;
    setTimeout(() => {
        checkAndTrigger(true);
        if (stressScore >= 100 && Date.now() > hijackCooldown) {
            triggerHijack();
        }
    }, 10);
  });

  editor.addEventListener('focus', () => {
    if (memeOverlay.style.display === 'flex') {
      editor.blur(); 
    }
  });

  editor.addEventListener('beforeinput', (e) => {
    if (memeOverlay.style.display === 'flex') {
      e.preventDefault();
      return;
    }
    if (locked && !e.inputType.startsWith('deleteContent')) {
      e.preventDefault();
      forceCaret();
    }
  });

  editor.addEventListener('keydown', (e) => {
    if (memeOverlay.style.display === 'flex') {
      e.preventDefault(); 
      e.stopPropagation();
      return; 
    }

    if (!locked) return;

    if (e.key === "Backspace" || e.key === "Delete") {
      e.preventDefault();
      STATS.deleteCount++;
      const span = editor.querySelector('.dmn-span');
      if (!span) { unlock(); return; }

      if (dmnPhase === "grow") {
        thoughtIndex += 2; 
        span.textContent = currentThought.slice(0, thoughtIndex);
        if (thoughtIndex >= currentThought.length) dmnPhase = "shrink";
        if (Math.random() < 0.25) spawnSidePop();
      } else {
        thoughtIndex -= 3;
        span.textContent = currentThought.slice(0, Math.max(0, thoughtIndex));
        if (thoughtIndex <= 0) unlock();
      }
    } else if (!e.ctrlKey && !e.metaKey && e.key !== "Shift") {
      e.preventDefault();
      showToast("æ‚å¿µå¤ªå¤šï¼Œæš‚æ—¶æ‰“ä¸å‡ºå­—...");
      forceCaret();
    }
    updateDebug();
  });

  function unlock() {
    const span = editor.querySelector('.dmn-span');
    if (span) span.remove();
    locked = false;
    currentThought = "";
    thoughtIndex = 0;
    editor.classList.remove('locked');
    triggerCooldown = Date.now() + 4000;
  }

  function insertDMN(text) {
    if (locked) return;
    STATS.distractionCount++;
    locked = true;
    dmnPhase = "grow";
    currentThought = text;
    thoughtIndex = Math.floor(text.length / 4); 
    editor.classList.add('locked');
    const sel = window.getSelection();
    if (!sel.rangeCount) editor.focus();
    const range = sel.getRangeAt(0);
    const span = document.createElement('span');
    span.className = 'dmn-span';
    span.contentEditable = 'false';
    span.textContent = currentThought.slice(0, thoughtIndex);
    range.insertNode(span);
    forceCaret();
    triggerCooldown = Date.now() + 5000;
  }

  function checkAndTrigger(forceTrigger = false) {
    const fullText = getUserText();
    const recentText = fullText.slice(-12); 
    const lastChar = recentText.slice(-1);
    
    const isPunctuation = /([ï¼Œã€‚,.\s])$/.test(lastChar);
    if (isPunctuation) {
        if (Math.random() < 0.05) spawnSidePop();
        return; 
    }

    let matchedThemeKey = null;
    let minDistance = 999;

    for(let key in THEME_POOLS) {
      if (key === "general") continue;
      const regex = THEME_POOLS[key].keywords;
      const match = recentText.match(regex);
      if (match) {
        const distance = recentText.length - (match.index + match[0].length);
        if (distance < 5 && distance < minDistance) {
          minDistance = distance;
          matchedThemeKey = key;
        }
      }
    }

    let shouldTrigger = false;
    let textToInsert = "";

    if (matchedThemeKey) {
      if (Math.random() < 0.50) {
        lastActiveTheme = matchedThemeKey;
        textToInsert = pick(THEME_POOLS[matchedThemeKey].texts);
        shouldTrigger = true;
      } else {
        lastActiveTheme = matchedThemeKey;
        if(Math.random() < 0.5) spawnSidePop();
      }
    } else {
      if (Math.random() < 0.04) {
        spawnSidePop();
      }
    }

    if (shouldTrigger && textToInsert) {
      insertDMN(textToInsert);
    }
  }

  editor.addEventListener('input', () => {
    if (locked) return;
    editor.classList.toggle('is-empty', editor.textContent === "");
    
    const text = getUserText().replace(/\s/g, ""); 
    currentLength = text.length;
    charCountEl.textContent = `${currentLength} / ${MIN_CHARS}`;
    if (currentLength >= MIN_CHARS) charCountEl.classList.add('done');
    else charCountEl.classList.remove('done');

    const now = Date.now();
    const timeGap = now - lastInputTime;
    lastInputTime = now;

    stressScore += 1.6; 
    
    if (Math.random() < 0.08) stressScore += 5;
    if (timeGap > 3000) stressScore = Math.max(0, stressScore - 15);

    if (isComposing) {
        if (Math.random() < 0.05) spawnSidePop();
        updateDebug();
        return; 
    }

    if (now > triggerCooldown) {
      checkAndTrigger();
    }

    if (stressScore >= 100 && now > hijackCooldown) {
      triggerHijack();
    }
    updateDebug();
  });

  function triggerHijack() {
    STATS.hijackCount++;
    memeOverlay.style.display = 'flex';
    setTimeout(() => memeOverlay.classList.add('active'), 10);
    editor.blur(); 
  }

  editor.addEventListener('paste', e => e.preventDefault());
  
  function updateDebug() {
    const cd = Math.max(0, Math.ceil((hijackCooldown - Date.now())/1000));
    const themeLabel = THEME_POOLS[lastActiveTheme] ? THEME_POOLS[lastActiveTheme].label : "æ— ";
    debugEl.textContent = `ç–²åŠ³åº¦: ${Math.floor(stressScore)}% | ä¸»é¢˜: ${themeLabel} | å†·å´: ${cd}s`;
  }
</script>

</body>
</html>