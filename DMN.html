<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ADHD æ¨¡æ‹Ÿå™¨ - æ·±åº¦è§£æå®Œæˆç‰ˆ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ========== ä¸»é¢˜è‰²å˜é‡ï¼ˆè“è‰²ï¼‰ ========== */
    :root{
      --primary: #3a80e8;
      --primary-600: #3a81ec;
      --primary-700: #3981ec;
      --primary-soft: #eff6ff;
      --primary-border: #bfdbfe;
    }

    /* ========== é¡¶éƒ¨å›ºå®šå¯¼èˆªæ  ========== */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: white;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
      z-index: 10000;
      padding: 0 20px;
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      color: var(--primary);
      font-size: 28px;
    }

    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .logo-subtitle {
      font-size: 14px;
      color: #6c757d;
      margin-top: -5px;
    }

    /* è¿”å›é¦–é¡µæŒ‰é’®ï¼ˆæ”¹ä¸ºè“è‰²ä¸»é¢˜ï¼‰ */
    .cta-button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 30px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .cta-button:hover {
      background-color: var(--primary-600);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
    }

    /* ========== é¡µé¢åŸºç¡€å¸ƒå±€ ========== */
    html, body {
      margin:0;
      padding:0;
      height:100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:#ecf3ff;
      overflow:hidden;
    }

    /* è®©ä¸»å¡ç‰‡å æ®æ›´å¤šå¯ç”¨ç©ºé—´ï¼Œé¿å…ä¸Šä¸‹æ‹¥æŒ¤ */
    .center-container{
      width:100%;
      height:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      padding-top: 86px; /* ä¸é¡¶éƒ¨å¯¼èˆªæ¡ç•™å‡ºç¨³å®šé—´è· */
      box-sizing: border-box;
    }

    /* ========== ä¸»ä»»åŠ¡å¡ç‰‡ ========== */
    .task-card{
      background:#fff;
      padding:24px 32px;
      border-radius:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.05);

      /* å¸ƒå±€æ¯”ä¾‹ä¼˜åŒ–ï¼šå¡ç‰‡ç•¥å®½ã€å†…éƒ¨æ”¹ä¸º flex åˆ—å¸ƒå±€ï¼Œç¼–è¾‘åŒºè‡ªé€‚åº”æ’‘æ»¡å‰©ä½™é«˜åº¦ */
      max-width: 1100px;
      width: min(1100px, calc(100vw - 48px));
      text-align:center;
      position:relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 12px;

      max-height: calc(100vh - 130px);
    }

    /* ========== å¡ç‰‡é¡¶éƒ¨æ ‡é¢˜æ  ========== */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom: 2px;
      gap: 16px;
      flex: 0 0 auto;
    }

    .topbar-left { text-align: left; }

    .topbar h1{ margin:0; font-size:28px; color:var(--primary); }

    .topbar p{
      margin:6px 0 0;
      font-size:16px;
      color:#6b7280;
      line-height: 1.4;
    }

    /* ========== æŒ‰é’®ç»„ ========== */
    .btn-group { display: flex; gap: 12px; flex: 0 0 auto; }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: transform 0.1s;
      text-decoration: none;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      white-space: nowrap;
    }

    .btn:active { transform: scale(0.96); }

    /* è“è‰²ä¸»æŒ‰é’®ï¼ˆå‘é€é‚®ä»¶ï¼‰ */
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-600); }

    .btn-reset { background: #f3f4f6; color: #4b5563; }

    .btn-science {
      background: var(--primary);
      color: white;
      width: 100%;
      margin-top: 20px;
      padding: 14px;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.18);
    }

    .btn-science:hover {
      background: var(--primary-600);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.24);
    }

    /* ========== ä»»åŠ¡è¦æ±‚æ¡† ========== */
    .require-box{
      text-align:left;
      background:#ffffff;
      border:1px solid #e1ebff;
      border-radius:14px;
      padding:16px 18px;

      /* æ¯”ä¾‹ä¼˜åŒ–ï¼šå‡å°‘ä¸å¿…è¦çš„å¤–è¾¹è·ï¼Œäº¤ç»™ task-card çš„ gap æ§åˆ¶é—´è· */
      margin: 0;
      flex: 0 0 auto;
    }

    .task-desc { color: #374151; font-size: 16px; line-height: 1.6; margin-bottom: 10px; font-weight: 500; }

    /* é«˜äº®æ ‡è®°ï¼šæ”¹ä¸ºè“è‰²ä¸»é¢˜ï¼Œé€šè¿‡å¢å¤§å­—å·å¼ºè°ƒ */
    .highlight {
      color: var(--primary-700);
      font-size: 18px;
      font-weight: 600;
    }

    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #6b7280;
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
      margin-top: 4px;
    }

    .progress-pill{
      background:#fff;
      border:1px solid #e5e7eb;
      padding:4px 10px;
      border-radius:4px;
      transition: all 0.3s;
    }

    .progress-pill.done {
      color: var(--primary);
      border-color: var(--primary-border);
      background: var(--primary-soft);
      font-weight: bold;
    }

    /* ========== æ–‡æœ¬ç¼–è¾‘å™¨ ========== */
    .editor{
      width:100%;
      /* æ¯”ä¾‹ä¼˜åŒ–ï¼šç¼–è¾‘å™¨è‡ªé€‚åº”å æ®å‰©ä½™ç©ºé—´ï¼Œä¸å†å›ºå®š 300px */
      flex: 1 1 auto;
      min-height: 260px;

      padding:16px;
      border-radius:12px;
      border:1px solid #d1d5db;
      background:#f3f7ff;
      text-align:left;
      outline:none;
      line-height:1.7;
      font-size:18px;
      overflow-y:auto;
      position:relative;
      box-sizing: border-box;
      z-index: 10;
    }

    .editor.locked { border-color: var(--primary); background: #eff6ff; animation: editorPulse 2s infinite; }

    @keyframes editorPulse {
      0%, 100% { box-shadow: 0 0 0px rgba(37, 99, 235, 0.2); }
      50% { box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }
    }

    .editor.is-empty::before{
      content: attr(data-placeholder);
      color:#9ca3af;
      pointer-events:none;
      position: absolute;
    }

    .dmn-span{ color: #a1a1aa; font-style: italic; letter-spacing: 0.5px; }

    /* ========== åº•éƒ¨å¯¼èˆªæ  ========== */
    .bottom-nav {
      margin-top: 0;
      padding-top: 8px;
      border-top: 1px solid #f3f4f6;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      flex: 0 0 auto;
    }

    .nav-link {
      text-decoration: none;
      color: #9ca3af;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      padding: 8px 12px;
      border-radius: 6px;
    }

    .nav-link:hover { background: #f3f4f6; color: #4b5563; }

    /* ========== ä¾§è¾¹æ‚å¿µå¼¹çª— ========== */
    .side-pop{
      position:absolute;
      width: 240px;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(255,255,255,0.95);
      border: 1px solid #e5e7eb;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      color: #6b7280;
      font-size: 13px;
      pointer-events:none;
      z-index: 20;
      text-align: left;
      line-height: 1.5;
      backdrop-filter: blur(4px);
      animation: popInOut 5s ease-in-out forwards;
    }

    @keyframes popInOut{
      0% { opacity:0; transform:translateY(15px) scale(0.95); }
      10% { opacity:1; transform:translateY(0) scale(1); }
      80% { opacity:1; transform:translateY(0) scale(1); }
      100% { opacity:0; transform:translateY(-15px) scale(0.95); }
    }

    /* ========== GIFåŠ«æŒå…¨å±é®ç½©å±‚ ========== */
    .meme-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.95);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:100;
      flex-direction:column;
    }

    @keyframes zoomIn { from { transform: scale(0.6); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }

    .meme-overlay.active .meme-content {
      animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .meme-overlay.active img { animation: glitch 0.3s infinite; }

    .meme-overlay img {
      max-width: 90vw;
      max-height: 80vh;
      object-fit: contain;
      border-radius:12px;
      border: 4px solid #fff;
      box-shadow: 0 0 50px rgba(255,255,255,0.3);
      margin-bottom: 20px;
    }

    .meme-hint{
      color:#fff;
      margin-bottom:15px;
      text-align:center;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }

    .btn-restore {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 40px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(37, 99, 235, 0.35);
      transition: transform 0.1s, box-shadow 0.1s;
      z-index: 101;
    }

    .btn-restore:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(37, 99, 235, 0.55);
      background: var(--primary-600);
    }
    .btn-restore:active {
      transform: scale(0.95);
      background: var(--primary-700);
    }

    /* ========== ä»»åŠ¡å®Œæˆç»“ç®—å¼¹çª— ========== */
    .success-overlay {
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.1);
      backdrop-filter: blur(8px);
      display:none;
      justify-content:center;
      align-items:center;
      z-index: 200;
    }

    .result-card {
      background: #fff;
      width: 600px;
      max-width: 90vw;
      max-height: 85vh;
      overflow-y: auto;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      text-align: center;
      animation: cardUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid #e5e7eb;
      margin-top: 11vh;
    }

    @keyframes cardUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .result-icon { font-size: 48px; margin-bottom: 10px; display:block; }
    .result-title { font-size: 24px; font-weight: bold; margin-bottom: 5px; color: #111827; }
    .result-desc { color: #6b7280; font-size: 14px; margin-bottom: 25px; }

    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 25px; }
    .stat-item { background: #f9fafb; padding: 10px; border-radius: 12px; border: 1px solid #f3f4f6; }
    .stat-val { display: block; font-size: 18px; font-weight: bold; color: #111827; }
    .stat-label { font-size: 11px; color: #9ca3af; }

    /* ========== ä½“éªŒè§£ç ç§‘æ™®åŒºåŸŸ ========== */
    .debrief-box {
        text-align: left;
        background: #f6f9ff;
        border: 1px solid #dcfce7;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }

    .debrief-title { font-size: 15px; font-weight: bold; color: #166534; margin-bottom: 12px; border-bottom: 1px solid #bbf7d0; padding-bottom: 8px; }
    .debrief-item { margin-bottom: 10px; font-size: 13px; color: #374151; line-height: 1.5; display: flex; gap: 8px; }
    .debrief-item:last-child { margin-bottom: 0; }
    .debrief-icon { font-size: 16px; min-width: 20px; }
    .debrief-bold { font-weight: 600; color: #111827; }

    /* ========== åº•éƒ¨æŒ‰é’®åŒºåŸŸ ========== */
    .result-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 30px;
    }

    .btn-result {
      padding: 15px 40px;
      border-radius: 35px;
      border: none;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-science-result {
      background: var(--primary);
      color: white;
    }

    .btn-science-result:hover {
      background: var(--primary-600);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-retry-result {
      background: #f3f4f6;
      color: #4b5563;
    }

    .btn-retry-result:hover {
      background: #e5e7eb;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    /* ========== åº•éƒ¨æç¤ºToast ========== */
    .toast{
      position:fixed;
      left:50%;
      bottom: 20%;
      transform:translateX(-50%);
      background: rgba(37, 99, 235, 0.95);
      color: #fff;
      padding: 16px 32px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
      opacity: 0;
      transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 200;
      pointer-events: none;
      white-space: nowrap;
    }

    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-10px); }
  </style>
</head>
<body>

<!-- å¤´éƒ¨å¯¼èˆª -->
    <div class="navbar">
        <div class="nav-container">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div>
                    <div class="logo-text">è®¤çŸ¥ä¹‹çª—</div>
                    <div class="logo-subtitle">ADHDç§‘æ™®ä½“éªŒå¹³å°</div>
                </div>
            </div>
            <a href="index.html" class="cta-button">
                <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
            </a>
        </div>
    </div>

<div class="center-container">
  <div class="task-card" id="taskCard">
    <div class="topbar">
      <div class="topbar-left">
        <h1>æ’°å†™ï¼šå‘¨æŠ¥è¿Ÿäº¤è§£é‡Šé‚®ä»¶</h1>
        <p>å¼€æ”¾ä»»åŠ¡ï¼šè¯·æ ¹æ®ä¸‹æ–¹è¦æ±‚æ’°å†™é‚®ä»¶ã€‚</p>
      </div>
      <div class="btn-group">
        <button class="btn btn-reset" onclick="location.reload()">é‡ç½®</button>
        <button class="btn btn-primary" id="submitBtn">å‘é€é‚®ä»¶</button>
      </div>
    </div>

    <div class="require-box">
      <div class="task-desc">
        ä»»åŠ¡ï¼šç»™é¢†å¯¼å†™ä¸€å°é‚®ä»¶ï¼Œè§£é‡Š<span class="highlight">å‘¨æŠ¥è¿Ÿäº¤</span>çš„åŸå› ï¼š<span class="highlight">æ•°æ®æ ¸å¯¹æœªå®Œæˆ</span>ï¼Œå¹¶<span class="highlight">æ˜ç¡®å‘ŠçŸ¥å…­ç‚¹å‰è¡¥äº¤</span>ã€‚<br>
        è¦æ±‚ï¼šè¯­ä¹‰é€šé¡ºï¼Œæ€åº¦è¯šæ³ï¼Œå†…å®¹å®Œæ•´ã€‚
      </div>
      <div class="task-meta">
        <span>æœ€ä½å­—æ•°è¦æ±‚ï¼š50å­—</span>
        <span class="progress-pill" id="charCount">0 / 50</span>
      </div>
    </div>

    <div id="editor" class="editor is-empty" contenteditable="true" spellcheck="false" data-placeholder="å°Šæ•¬çš„é¢†å¯¼ï¼Œéå¸¸æŠ±æ­‰..."></div>
  </div>
</div>

<div class="meme-overlay" id="memeOverlay">
  <div class="meme-content">
    <div class="meme-hint">âš  æ€ç»´è¢«æ‰“æ–­ âš </div>
    <img src="meme.gif" alt="Focus Hijack">
    <button class="btn-restore" id="closeHijackBtn">å¼ºåˆ¶é‡å¯å¤§è„‘</button>
  </div>
</div>

<div class="success-overlay" id="successOverlay">
  <div class="result-card">
    <span class="result-icon">ğŸ‰</span>
    <div class="result-title">é‚®ä»¶å‘é€æˆåŠŸï¼</div>
    <div class="result-desc">ä½ æˆåŠŸå…‹æœäº†æ‹–å»¶ä¸ç„¦è™‘ï¼Œä½†åˆšæ‰çš„ä½“éªŒå¹¶éæ¸¸æˆã€‚</div>

    <div class="stats-grid">
      <div class="stat-item">
        <span class="stat-val" id="statTime">0s</span>
        <span class="stat-label">æ€»è€—æ—¶</span>
      </div>
      <div class="stat-item">
        <span class="stat-val" id="statDeletes">0</span>
        <span class="stat-label">åˆ é™¤æ‚å¿µ</span>
      </div>
      <div class="stat-item">
        <span class="stat-val" id="statDistractions">0</span>
        <span class="stat-label">æ€ç»´é˜»æ–­</span>
      </div>
      <div class="stat-item">
        <span class="stat-val" id="statHijacks">0</span>
        <span class="stat-label">è¢«GIFåŠ«æŒ</span>
      </div>
    </div>

    <div class="debrief-box">
        <div class="debrief-title">ğŸ”¬ åˆšæ‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿä½“éªŒèƒŒåçš„ç¥ç»ç§‘å­¦ï¼š</div>

        <div class="debrief-item">
            <span class="debrief-icon">ğŸ‘»</span>
            <div>
                <span class="debrief-bold">è‡ªåŠ¨ç”Ÿæˆçš„ç°å­— (æ€ç»´é˜»æ–­)ï¼š</span>
                æ¨¡æ‹Ÿ <b>DMNï¼ˆé»˜è®¤æ¨¡å¼ç½‘ç»œï¼‰è¿‡åº¦æ´»è·ƒ</b>ã€‚å³ä¾¿ä½ æƒ³ä¸“æ³¨ï¼Œå¤§è„‘ä¹Ÿä¼šä¸æ–­äº§ç”Ÿæ‚å¿µã€è‡ªæˆ‘è´¨ç–‘ï¼ˆ"è¿™æ ·å†™å¯¹å—ï¼Ÿ"ï¼‰å’Œæ— å…³è”æƒ³ï¼Œå¹²æ‰°ä½ çš„æ€è€ƒæµã€‚
            </div>
        </div>

        <div class="debrief-item">
            <span class="debrief-icon">ğŸˆ</span>
            <div>
                <span class="debrief-bold">å¼ºåˆ¶å…¨å±åŠ¨å›¾ (GIFåŠ«æŒ)ï¼š</span>
                æ¨¡æ‹Ÿ <b>å¤šå·´èƒºåŒ®ä¹å¯¼è‡´çš„å‰é¢å¶â€œæ­»æœºâ€</b>ã€‚å½“è®¤çŸ¥ç–²åŠ³è¾¾åˆ°æé™ï¼Œå¤§è„‘ä¼šå¼ºåˆ¶åˆ‡æ–­ä»»åŠ¡è¿æ¥ï¼Œå¯»æ‰¾é«˜åˆºæ¿€æºï¼ˆå¦‚åˆ·æ‰‹æœºã€å‘å‘†ï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„â€œæ–­ç‰‡â€ã€‚
            </div>
        </div>

        <div class="debrief-item">
            <span class="debrief-icon">ğŸ›‘</span>
            <div>
                <span class="debrief-bold">åˆ ä¸æ‰çš„é”™å­—/é˜»åŠ›ï¼š</span>
                æ¨¡æ‹Ÿ <b>æ‰§è¡ŒåŠŸèƒ½éšœç¢</b>ã€‚è¿™æ˜¯å…¸å‹çš„<b>â€œæ„å‘-è¡ŒåŠ¨æ–­è£‚â€</b>ã€‚å¤§è„‘æ¸…æ¥šåœ°å‘å‡ºäº†æŒ‡ä»¤ï¼Œä½†èº«ä½“å´åƒâ€œé¬¼å‹åºŠâ€ä¸€æ ·æ— æ³•å“åº”ã€‚ç®€å•çš„çº é”™åŠ¨ä½œï¼Œåœ¨ç¥ç»å›è·¯ä¸­é­é‡äº†å·¨å¤§çš„<b>è®¤çŸ¥æ‘©æ“¦</b>ï¼Œå˜å¾—å¯¸æ­¥éš¾è¡Œã€‚
            </div>
        </div>
    </div>

    <div class="result-actions">
        <a href="kepu_1.html#dmn" class="btn-result btn-science-result">
            <i class="fas fa-graduation-cap"></i> æŸ¥çœ‹ç§‘æ™®
        </a>
        <button class="btn-result btn-retry-result" onclick="location.reload()">
            <i class="fas fa-redo"></i> é‡æ–°ä½“éªŒ
        </button>
    </div>
  </div>
</div>

<div class="toast" id="toast">æç¤º</div>

<script>
  const MIN_CHARS = 50;
  const STATS = { startTime: Date.now(), deleteCount: 0, distractionCount: 0, hijackCount: 0 };

  const THEME_POOLS = {
    etiquette: {
      label: "ç¤¾äº¤ç¤¼ä»ª",
      keywords: /(æ‚¨|é¢†å¯¼|ç»ç†|è€å¸ˆ|æŠ±æ­‰|ä¸å¥½æ„æ€|è¾›è‹¦)/,
      texts: [
        "â€¦è¯­æ°”ä¼šä¸ä¼šå¤ªå‘å¾®äº†ï¼Ÿä¸‡ä¸€ä»–è§‰å¾—æˆ‘æ€åº¦ä¸ç«¯æ­£æ€ä¹ˆåŠï¼Ÿ",
        "â€¦è¦ä¸è¦å…ˆé—®å€™ä¸€ä¸‹ï¼Ÿä¸Šæ¬¡ä»–è¯´å…»äº†çŒ«ï¼Œåº”è¯¥å…³å¿ƒä¸€ä¸‹å—ï¼Ÿ",
        "â€¦ä»–ç°åœ¨è‚¯å®šåœ¨ç”Ÿæ°”ã€‚æˆ‘åº”è¯¥åœ¨å¼€å¤´å°±é“æ­‰è¿˜æ˜¯å…ˆè§£é‡ŠåŸå› å†é“æ­‰ï¼Ÿ",
        "â€¦è¿™å¥è¯è¯»èµ·æ¥æœ‰ç‚¹ç”Ÿç¡¬ã€‚è¦ä¸è¦åŠ ä¸ª'è¯šæŒšåœ°'æ˜¾å¾—çœŸè¯šä¸€ç‚¹ï¼Ÿ"
      ]
    },
    logic: {
      label: "é€»è¾‘æ¼æ´",
      keywords: /(å› ä¸º|å¯¼è‡´|æ‰€ä»¥|ç›®å‰|ä½†æ˜¯|ç„¶è€Œ|ç”±äº)/,
      texts: [
        "â€¦è¿™é€»è¾‘æ ¹æœ¬è¯´ä¸é€šå§ï¼Ÿä»–ä¸€çœ¼å°±èƒ½çœ‹ç©¿è¿™åªæ˜¯å€Ÿå£è€Œå·²ã€‚",
        "â€¦ä¸»ä½“åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘è‡ªå·±éƒ½æ²¡ææ¸…æ¥šï¼Œä¸‡ä¸€ä»–è¿½é—®æ€ä¹ˆåŠï¼Ÿ",
        "â€¦è¦ä¸è¦å‡†å¤‡ä¸ªå…·ä½“è¿›åº¦ï¼Ÿè¯´'å¤§éƒ¨åˆ†å®Œæˆ'ä¼šä¸ä¼šå¤ªå«ç³Šäº†ï¼Ÿ"
      ]
    },
    data_panic: {
      label: "æ•°æ®ææ…Œ",
      keywords: /(æ•°æ®|æ ¸å¯¹|é”å®š|å‡†ç¡®|æº|æ£€æŸ¥|å¯¹è´¦)/,
      texts: [
        "â€¦é”å®šåå°±ä¸èƒ½æ”¹äº†ã€‚è¦ä¸è¦å†æ£€æŸ¥ä¸€éé”€å”®é¢ï¼Ÿä¸‡ä¸€é”™äº†â€¦",
        "â€¦é‚£ä¸ªè¡¨æ ¼æ˜¯ä¸‰ä¸ªSheetè¿˜æ˜¯å››ä¸ªï¼Ÿæˆ‘æ€ä¹ˆè®°ä¸æ¸…äº†ï¼Œè¦ä¸è¦ç¡®è®¤ï¼Ÿ",
        "â€¦VLOOKUPå…¬å¼æ‹‰åˆ°åº•äº†å—ï¼Ÿæœ€åå‡ è¡Œæ˜¯ç©ºçš„è¿˜æ˜¯æˆ‘å¿˜äº†å¡«å……ï¼Ÿ"
      ]
    },
    time_panic: {
      label: "æ—¶é—´ææ…Œ",
      keywords: /(æ—¶é—´|å…­ç‚¹|é¢„è®¡|è¿Ÿ|æ™š|18:00)/,
      texts: [
        "â€¦å…­ç‚¹ä¼šä¸ä¼šæ—¶é—´ä¸å¤Ÿï¼Ÿç°åœ¨éƒ½å››ç‚¹åŠäº†ï¼Œè¦ä¸è¦æ”¹æˆ'ä»Šæ™šå‰'ï¼Ÿ",
        "â€¦è¿™æ—¶å€™å‘ä»–ä¼šçœ‹åˆ°å—ï¼Ÿä¸‡ä¸€ä¸‹ç­äº†ï¼Œæ˜å¤©æ‰å›å¤æ€ä¹ˆåŠï¼Ÿ",
        "â€¦ä¸‡ä¸€å…­ç‚¹ä¹Ÿäº¤ä¸å‡ºå‘¢ï¼Ÿæ˜¯ä¸æ˜¯åº”è¯¥è¯´'å°½é‡å…­ç‚¹å‰'ç•™ç‚¹ä½™åœ°ï¼Ÿ"
      ]
    },
    general: {
      label: "æ‚å¿µ",
      keywords: /.*/,
      texts: [
        "â€¦å¥½é¥¿å•Šã€‚ä¸­åˆé‚£ä¸ªæ²™æ‹‰æ ¹æœ¬ä¸é¡¶é¥±ï¼Œè¦ä¸è¦å«ä¸ªå¤–å–ï¼Ÿ",
        "â€¦é‚£ä¸ªçº¢ç‚¹è¿˜åœ¨é—ªã€‚æ˜¯é‡è¦æ¶ˆæ¯å—ï¼Ÿè¦ä¸è¦å…ˆçœ‹ä¸€çœ¼å†è¯´ï¼Ÿ",
        "â€¦æˆ‘æ˜¯ä¸æ˜¯ä¸é€‚åˆè¿™å·¥ä½œï¼Ÿæ¯æ¬¡éƒ½æ‹–åˆ°æœ€åï¼Œèƒ½åŠ›æœ‰é—®é¢˜å§ï¼Ÿ",
        "â€¦æ‰‹æœºåˆšæ‰éœ‡äº†å—ï¼Ÿå¥½åƒæœ‰éœ‡åŠ¨ï¼Œä½†å±å¹•æ²¡æ˜¾ç¤ºï¼Œæ˜¯å¹»è§‰ï¼Ÿ",
        "â€¦çª—å¤–çš„é¸Ÿä¸€ç›´å«ã€‚æ˜¯éº»é›€è¿˜æ˜¯å–œé¹Šï¼Ÿä¸ºä»€ä¹ˆå«è¿™ä¹ˆå¤§å£°ï¼Ÿ"
      ]
    }
  };

  let lastActiveTheme = "logic";
  let locked = false;
  let dmnPhase = "grow";
  let currentThought = "";
  let thoughtIndex = 0;
  let triggerCooldown = 0;
  let stressScore = 0;
  let lastInputTime = Date.now();
  let hijackCooldown = 0;
  let currentLength = 0;
  let isComposing = false;

  const editor = document.getElementById('editor');
  const taskCard = document.getElementById('taskCard');
  const toast = document.getElementById('toast');
  const memeOverlay = document.getElementById('memeOverlay');
  const successOverlay = document.getElementById('successOverlay');
  const submitBtn = document.getElementById('submitBtn');
  const closeHijackBtn = document.getElementById('closeHijackBtn');
  const charCountEl = document.getElementById('charCount');

  function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
  function showToast(msg) {
    toast.textContent = msg; toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
  }

  function getUserText() {
    const clone = editor.cloneNode(true);
    clone.querySelectorAll('.dmn-span').forEach(s => s.remove());
    return clone.textContent || "";
  }

  function forceCaret() {
    if (!locked) return;
    const span = editor.querySelector('.dmn-span');
    if (!span) return;
    const sel = window.getSelection();
    const range = document.createRange();
    range.setStartBefore(span);
    range.collapse(true);
    sel.removeAllRanges();
    sel.addRange(range);
  }

  function spawnSidePop() {
    if (document.querySelectorAll('.side-pop').length > 5) return;
    const pop = document.createElement('div');
    pop.className = 'side-pop';
    const poolKey = Math.random() < 0.6 ? lastActiveTheme : pick(Object.keys(THEME_POOLS));
    pop.textContent = pick(THEME_POOLS[poolKey].texts);
    const cardRect = taskCard.getBoundingClientRect();
    const x = 20 + Math.random() * (cardRect.width - 280);
    const y = 80 + Math.random() * (cardRect.height - 140);
    pop.style.left = x + 'px';
    pop.style.top = y + 'px';
    taskCard.appendChild(pop);
    setTimeout(() => { if(pop.parentNode) pop.remove(); }, 5000);
  }

  submitBtn.addEventListener('click', () => {
    if (currentLength < MIN_CHARS) {
      showToast(`å†…å®¹å¤ªå°‘äº†ï¼è‡³å°‘éœ€è¦å†™ ${MIN_CHARS} å­— (å½“å‰: ${currentLength})`);
      return;
    }
    const duration = Math.floor((Date.now() - STATS.startTime) / 1000);
    document.getElementById('statTime').textContent = duration + "s";
    document.getElementById('statDeletes').textContent = STATS.deleteCount;
    document.getElementById('statDistractions').textContent = STATS.distractionCount;
    document.getElementById('statHijacks').textContent = STATS.hijackCount;
    successOverlay.style.display = 'flex';
  });

  closeHijackBtn.addEventListener('click', () => {
    memeOverlay.classList.remove('active');
    memeOverlay.style.display = 'none';
    stressScore = 0;
    hijackCooldown = Date.now() + 20000;
    editor.focus();
    showToast("å¤šå·´èƒºå¹³å¤ï¼Œæ³¨æ„åŠ›å›å½’...");
  });

  editor.addEventListener('compositionstart', (e) => {
    if (locked) {
      editor.blur();
      setTimeout(() => { editor.focus(); forceCaret(); }, 10);
      showToast("æ‚å¿µå¤ªå¤šï¼Œæš‚æ—¶æ‰“ä¸å‡ºå­—...å…ˆåˆ å»æ‚å¿µå§");
      return;
    }
    isComposing = true;
  });

  editor.addEventListener('compositionend', (e) => {
    isComposing = false;
    setTimeout(() => {
        checkAndTrigger(true);
        if (stressScore >= 100 && Date.now() > hijackCooldown) {
            triggerHijack();
        }
    }, 10);
  });

  editor.addEventListener('focus', () => {
    if (memeOverlay.style.display === 'flex') {
      editor.blur();
    }
  });

  editor.addEventListener('beforeinput', (e) => {
    if (memeOverlay.style.display === 'flex') {
      e.preventDefault();
      return;
    }
    if (locked && !e.inputType.startsWith('deleteContent')) {
      e.preventDefault();
      forceCaret();
    }
  });

  editor.addEventListener('keydown', (e) => {
    if (memeOverlay.style.display === 'flex') {
      e.preventDefault();
      e.stopPropagation();
      return;
    }

    if (!locked) return;

    if (e.key === "Backspace" || e.key === "Delete") {
      e.preventDefault();
      STATS.deleteCount++;
      const span = editor.querySelector('.dmn-span');
      if (!span) { unlock(); return; }

      if (dmnPhase === "grow") {
        thoughtIndex += 2;
        span.textContent = currentThought.slice(0, thoughtIndex);
        if (thoughtIndex >= currentThought.length) dmnPhase = "shrink";
        if (Math.random() < 0.25) spawnSidePop();
      } else {
        thoughtIndex -= 3;
        span.textContent = currentThought.slice(0, Math.max(0, thoughtIndex));
        if (thoughtIndex <= 0) unlock();
      }
    } else if (!e.ctrlKey && !e.metaKey && e.key !== "Shift") {
      e.preventDefault();
      showToast("æ‚å¿µå¤ªå¤šï¼Œæš‚æ—¶æ‰“ä¸å‡ºå­—...å…ˆåˆ å»æ‚å¿µå§");
      forceCaret();
    }
  });

  function unlock() {
    const span = editor.querySelector('.dmn-span');
    if (span) span.remove();
    locked = false;
    currentThought = "";
    thoughtIndex = 0;
    editor.classList.remove('locked');
    triggerCooldown = Date.now() + 4000;
  }

  function insertDMN(text) {
    if (locked) return;
    STATS.distractionCount++;
    locked = true;
    dmnPhase = "grow";
    currentThought = text;
    thoughtIndex = Math.floor(text.length / 4);
    editor.classList.add('locked');
    const sel = window.getSelection();
    if (!sel.rangeCount) editor.focus();
    const range = sel.getRangeAt(0);
    const span = document.createElement('span');
    span.className = 'dmn-span';
    span.contentEditable = 'false';
    span.textContent = currentThought.slice(0, thoughtIndex);
    range.insertNode(span);
    forceCaret();
    triggerCooldown = Date.now() + 5000;
  }

  function checkAndTrigger(forceTrigger = false) {
    const fullText = getUserText();
    const recentText = fullText.slice(-12);
    const lastChar = recentText.slice(-1);

    const isPunctuation = /([ï¼Œã€‚,.\s])$/.test(lastChar);
    if (isPunctuation) {
        if (Math.random() < 0.05) spawnSidePop();
        return;
    }

    let matchedThemeKey = null;
    let minDistance = 999;

    for(let key in THEME_POOLS) {
      if (key === "general") continue;
      const regex = THEME_POOLS[key].keywords;
      const match = recentText.match(regex);
      if (match) {
        const distance = recentText.length - (match.index + match[0].length);
        if (distance < 5 && distance < minDistance) {
          minDistance = distance;
          matchedThemeKey = key;
        }
      }
    }

    let shouldTrigger = false;
    let textToInsert = "";

    if (matchedThemeKey) {
      if (Math.random() < 0.50) {
        lastActiveTheme = matchedThemeKey;
        textToInsert = pick(THEME_POOLS[matchedThemeKey].texts);
        shouldTrigger = true;
      } else {
        lastActiveTheme = matchedThemeKey;
        if(Math.random() < 0.5) spawnSidePop();
      }
    } else {
      if (Math.random() < 0.04) {
        spawnSidePop();
      }
    }

    if (shouldTrigger && textToInsert) {
      insertDMN(textToInsert);
    }
  }

  editor.addEventListener('input', () => {
    if (locked) return;
    editor.classList.toggle('is-empty', editor.textContent === "");

    const text = getUserText().replace(/\s/g, "");
    currentLength = text.length;
    charCountEl.textContent = `${currentLength} / ${MIN_CHARS}`;
    if (currentLength >= MIN_CHARS) charCountEl.classList.add('done');
    else charCountEl.classList.remove('done');

    const now = Date.now();
    const timeGap = now - lastInputTime;
    lastInputTime = now;

    stressScore += 1.6;

    if (Math.random() < 0.08) stressScore += 5;
    if (timeGap > 3000) stressScore = Math.max(0, stressScore - 15);

    if (isComposing) {
        if (Math.random() < 0.05) spawnSidePop();
        return;
    }

    if (now > triggerCooldown) {
      checkAndTrigger();
    }

    if (stressScore >= 100 && now > hijackCooldown) {
      triggerHijack();
    }
  });

  function triggerHijack() {
    STATS.hijackCount++;
    memeOverlay.style.display = 'flex';
    setTimeout(() => memeOverlay.classList.add('active'), 10);
    editor.blur();
  }

  editor.addEventListener('paste', e => e.preventDefault());
</script>

</body>
</html>
